name: Release Build

on:
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build for ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
      - name: Checkout Code
        uses: actions/checkout@v5

      - name: Set up JDK 23
        uses: actions/setup-java@v4
        with:
          java-version: '23'
          distribution: 'temurin'

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3

      - name: Grant Execute Permission for Gradlew
        if: runner.os != 'Windows'
        run: chmod +x gradlew

      # Builds the app and creates the zip distribution
      # We override the project version with the release tag name (e.g., v1.0.0)
      - name: Build Distribution
        shell: bash
        run: ./gradlew :launcher:distZip -Pversion=${{ github.ref_name }}

      - name: Prepare Release Artifact
        shell: bash
        run: |
          # Define the OS suffix
          if [ "${{ runner.os }}" == "Windows" ]; then
            OS_SUFFIX="windows"
          elif [ "${{ runner.os }}" == "macOS" ]; then
            OS_SUFFIX="mac"
          else
            OS_SUFFIX="linux"
          fi
          
          # Go to distribution folder
          cd launcher/build/distributions
          
          # Find the generated zip (e.g., PgDeveloper-v1.0.0.zip)
          ORIGINAL_ZIP=$(ls *.zip)
          
          # Rename it to include the OS (e.g., PgDeveloper-v1.0.0-windows.zip)
          NEW_NAME="${ORIGINAL_ZIP%.*}-$OS_SUFFIX.zip"
          mv "$ORIGINAL_ZIP" "$NEW_NAME"
          
          # Save the path to an env var for the upload step
          echo "ARTIFACT_PATH=launcher/build/distributions/$NEW_NAME" >> $GITHUB_ENV

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: ${{ env.ARTIFACT_PATH }}